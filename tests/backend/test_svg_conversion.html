<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG foreignObject â†’ text è½¬æ¢æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1783FF;
            margin-bottom: 10px;
        }
        .description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #1783FF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #0d6edf;
        }
        .output {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow: auto;
        }
        pre {
            margin: 0;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            color: #00C9C9;
            font-weight: bold;
        }
        .warning {
            color: #F0884D;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ SVG foreignObject â†’ text è½¬æ¢æµ‹è¯•</h1>
        <p class="description">
            æµ‹è¯• AntV Infographic å¯¼å‡ºçš„ SVG æ˜¯å¦å·²è‡ªåŠ¨å°† foreignObject+span è½¬æ¢ä¸ºæ ‡å‡† &lt;text&gt; å…ƒç´ ï¼Œä»¥ç¡®ä¿ PowerPoint å…¼å®¹æ€§ã€‚
        </p>

        <div class="test-section">
            <h3>ğŸ“ è¾“å…¥æµ‹è¯•æ–‡æœ¬</h3>
            <textarea id="testInput" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">PDCA æ˜¯ç”± Planã€Doã€Checkã€Action å››ä¸ªé˜¶æ®µç»„æˆçš„æŒç»­æ”¹è¿›å¾ªç¯ã€‚

è®¡åˆ’é˜¶æ®µï¼šæ˜ç¡®ç›®æ ‡ã€åˆ¶å®šæ–¹æ¡ˆä¸èµ„æºå®‰æ’ï¼Œä¸ºåç»­æ‰§è¡Œæ‰“å¥½åŸºç¡€ã€‚</textarea>
            <button onclick="generateAndTest()">ç”Ÿæˆä¿¡æ¯å›¾å¹¶æµ‹è¯•</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç”Ÿæˆçš„ SVG é¢„è§ˆ</h3>
            <div id="svgPreview" style="border: 1px solid #ddd; padding: 20px; background: white; min-height: 200px; text-align: center; color: #999;">
                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆä¿¡æ¯å›¾
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” SVG æºç åˆ†æ</h3>
            <button onclick="analyzeSVG()">åˆ†æ SVG ç»“æ„</button>
            <div class="output" id="analysisOutput" style="display: none;">
                <pre id="analysisText"></pre>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¾ ä¸‹è½½æµ‹è¯•</h3>
            <button onclick="downloadSVG()">ä¸‹è½½ SVG æ–‡ä»¶</button>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                ä¸‹è½½åå¯ä»¥ï¼š<br>
                1. ç”¨æµè§ˆå™¨æ‰“å¼€éªŒè¯æ¸²æŸ“<br>
                2. ç›´æ¥æ‹–å…¥ PowerPoint æµ‹è¯•æ–‡æœ¬æ˜¾ç¤º<br>
                3. ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æŸ¥çœ‹æ˜¯å¦ä½¿ç”¨äº† &lt;text&gt; è€Œé foreignObject
            </p>
        </div>
    </div>

    <script type="module">
        import { Infographic } from 'http://localhost:5173/node_modules/@antv/infographic/esm/index.js';

        let currentInfographic = null;
        let currentSVG = null;

        window.generateAndTest = async function() {
            const input = document.getElementById('testInput').value;
            const preview = document.getElementById('svgPreview');
            
            try {
                // æ¸…ç©ºé¢„è§ˆåŒºåŸŸ
                preview.innerHTML = 'ç”Ÿæˆä¸­...';
                
                // åˆ›å»ºä¸´æ—¶å®¹å™¨
                const container = document.createElement('div');
                container.style.width = '800px';
                container.style.height = '600px';
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                document.body.appendChild(container);
                
                // ç”Ÿæˆä¿¡æ¯å›¾
                const infographic = new Infographic({
                    container,
                    data: { text: input }
                });
                
                await infographic.render();
                currentInfographic = infographic;
                
                // è·å– SVG æ•°æ®
                const svgDataURL = await infographic.toDataURL({ type: 'svg', dpr: 2 });
                
                // è§£æ data URL
                const svgContent = decodeURIComponent(svgDataURL.split(',')[1]);
                currentSVG = svgContent;
                
                // æ˜¾ç¤ºåœ¨é¢„è§ˆåŒº
                preview.innerHTML = svgContent;
                
                // æ¸…ç†ä¸´æ—¶å®¹å™¨
                document.body.removeChild(container);
                
                // è‡ªåŠ¨åˆ†æ
                analyzeSVG();
                
            } catch (error) {
                preview.innerHTML = `<span class="warning">ç”Ÿæˆå¤±è´¥ï¼š${error.message}</span>`;
                console.error('ç”Ÿæˆå¤±è´¥:', error);
            }
        };

        window.analyzeSVG = function() {
            if (!currentSVG) {
                alert('è¯·å…ˆç”Ÿæˆä¿¡æ¯å›¾');
                return;
            }
            
            const output = document.getElementById('analysisOutput');
            const text = document.getElementById('analysisText');
            
            // åˆ†æ SVG å†…å®¹
            const hasForeignObject = currentSVG.includes('foreignObject');
            const hasTextElement = currentSVG.includes('<text');
            const spanCount = (currentSVG.match(/<span/g) || []).length;
            const textCount = (currentSVG.match(/<text/g) || []).length;
            
            let result = '=== SVG ç»“æ„åˆ†æç»“æœ ===\n\n';
            
            if (hasForeignObject) {
                result += 'âŒ å‘ç° foreignObject å…ƒç´ \n';
                result += `   - æ•°é‡ï¼š${(currentSVG.match(/foreignObject/g) || []).length}\n`;
                result += `   - <span> æ•°é‡ï¼š${spanCount}\n`;
                result += '   âš ï¸  è¿™å¯èƒ½å¯¼è‡´ PowerPoint ä¸­æ–‡æœ¬æ— æ³•æ˜¾ç¤ºï¼\n\n';
            } else {
                result += 'âœ… æœªå‘ç° foreignObject å…ƒç´ \n\n';
            }
            
            if (hasTextElement) {
                result += `âœ… å‘ç°æ ‡å‡† <text> å…ƒç´ \n`;
                result += `   - æ•°é‡ï¼š${textCount}\n`;
                result += '   âœ“ PowerPoint åº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºæ–‡æœ¬\n\n';
            } else {
                result += 'âŒ æœªå‘ç° <text> å…ƒç´ \n\n';
            }
            
            // æå–å¹¶æ˜¾ç¤ºæ‰€æœ‰ text å…ƒç´ 
            const textMatches = currentSVG.matchAll(/<text[^>]*>([^<]+)<\/text>/g);
            const texts = [...textMatches];
            
            if (texts.length > 0) {
                result += '=== æå–çš„æ–‡æœ¬å†…å®¹ ===\n\n';
                texts.forEach((match, index) => {
                    result += `æ–‡æœ¬ ${index + 1}: ${match[1].trim()}\n`;
                });
                result += '\n';
            }
            
            // æ€»ç»“
            result += '=== å…¼å®¹æ€§è¯„ä¼° ===\n\n';
            if (!hasForeignObject && hasTextElement) {
                result += 'ğŸ‰ è½¬æ¢æˆåŠŸï¼æ­¤ SVG ä¸ PowerPoint å®Œå…¨å…¼å®¹ï¼\n';
            } else if (hasForeignObject) {
                result += 'âš ï¸  è½¬æ¢æœªç”Ÿæ•ˆï¼Œä»ä½¿ç”¨ foreignObjectï¼Œéœ€è¦æ£€æŸ¥ä»£ç ã€‚\n';
            } else {
                result += 'â“ æ— æ³•ç¡®å®šï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚\n';
            }
            
            text.textContent = result;
            output.style.display = 'block';
        };

        window.downloadSVG = function() {
            if (!currentSVG) {
                alert('è¯·å…ˆç”Ÿæˆä¿¡æ¯å›¾');
                return;
            }
            
            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'infographic_ppt_compatible.svg';
            a.click();
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>
