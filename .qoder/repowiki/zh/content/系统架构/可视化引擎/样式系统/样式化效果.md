# 样式化效果

<cite>
**本文档引用的文件**
- [gradient.ts](file://antv_infographic/infographic/src/renderer/stylize/gradient.ts)
- [rough.ts](file://antv_infographic/infographic/src/renderer/stylize/rough.ts)
- [pattern.ts](file://antv_infographic/infographic/src/renderer/stylize/pattern.ts)
- [patterns/index.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/index.ts)
- [patterns/diamond.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/diamond.ts)
- [patterns/dot.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/dot.ts)
- [patterns/hex.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/hex.ts)
- [patterns/line.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/line.ts)
- [patterns/mosaic.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/mosaic.ts)
- [patterns/square.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/square.ts)
</cite>

## 目录
1. [渐变效果](#渐变效果)
2. [图案填充系统](#图案填充系统)
3. [粗糙化渲染](#粗糙化渲染)
4. [图案与SVG元素结合](#图案与svg元素结合)
5. [性能优化建议](#性能优化建议)
6. [兼容性说明](#兼容性说明)

## 渐变效果

AntV Infographic 提供了强大的渐变功能，支持线性渐变和径向渐变两种类型。渐变效果通过 `applyGradientStyle` 函数实现，该函数接收SVG元素、SVG容器、渐变配置和属性类型（fill或stroke）作为参数。

线性渐变通过 `linearGradient` 元素实现，支持角度配置。角度值以度为单位，0度表示x轴正方向，90度表示y轴正方向。系统会自动将角度转换为单位向量，用于确定渐变的起点和终点。径向渐变通过 `radialGradient` 元素实现，创建从中心向外辐射的色彩过渡效果。

渐变配置支持自动推断功能。当未明确指定颜色时，系统会根据当前颜色的明暗度自动创建渐变：对于深色，会生成从原色到提亮20%的颜色的渐变；对于浅色，会生成从加深20%的颜色到原色的渐变。这种智能推断机制简化了开发者的配置工作。

渐变ID的生成基于配置参数，包括渐变类型、颜色组合和角度（对于线性渐变），确保了唯一性和可缓存性。通过 `getOrCreateDefs` 工具函数，系统会在SVG的defs元素中查找或创建渐变定义，如果已存在相同ID的渐变则进行更新，否则添加新的渐变定义。

**节来源**
- [gradient.ts](file://antv_infographic/infographic/src/renderer/stylize/gradient.ts#L6-L132)

## 图案填充系统

AntV Infographic 的图案填充系统提供了一套丰富的内置图案，包括diamond（菱形）、dot（圆点）、hex（六边形）、line（线条）、mosaic（马赛克）和square（方块）等。这些图案通过模块化设计实现，每个图案都有独立的生成器函数，便于维护和扩展。

图案系统采用注册机制，通过 `registerPattern` 函数将图案生成器注册到全局映射表中。所有内置图案在 `patterns/index.ts` 文件中被批量注册，开发者也可以自定义图案并注册到系统中。图案生成器函数接收样式配置参数，返回一个SVG pattern元素。

每个图案都有其独特的视觉特征和生成算法：
- **菱形图案**：在20×20的单元格中绘制两条交叉的对角线，形成菱形网格
- **圆点图案**：在单元格的左上和右下位置绘制两个圆形，创建对角分布的圆点效果
- **六边形图案**：使用SVG路径绘制正六边形，形成蜂窝状结构
- **线条图案**：绘制两条交叉的斜线，创建X形图案
- **马赛克图案**：将单元格划分为4×4的网格，交替填充前景色和背景色
- **方块图案**：在单元格内绘制一个较小的方块，形成框中框效果

所有图案都支持缩放变换，通过 `patternTransform` 属性实现，允许开发者调整图案的密度和大小。

**节来源**
- [pattern.ts](file://antv_infographic/infographic/src/renderer/stylize/pattern.ts#L8-L75)
- [patterns/index.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/index.ts#L1-L7)
- [patterns/diamond.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/diamond.ts#L1-L30)
- [patterns/dot.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/dot.ts#L1-L38)
- [patterns/hex.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/hex.ts#L1-L30)
- [patterns/line.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/line.ts#L1-L47)
- [patterns/mosaic.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/mosaic.ts#L1-L46)
- [patterns/square.ts](file://antv_infographic/infographic/src/renderer/stylize/patterns/square.ts#L1-L30)

## 粗糙化渲染

粗糙化渲染功能基于 roughjs 库实现，为SVG元素添加手绘风格的视觉效果。`applyRoughStyle` 函数是粗糙化渲染的核心，它接收SVG元素、SVG容器和粗糙化配置作为参数。

该功能的工作原理是：首先创建一个 roughjs 的SVG渲染器实例，然后克隆原始SVG元素作为"体积层"（保留原始外观但降低透明度），再使用 roughjs 重新绘制具有手绘风格的元素。这两个元素被包裹在一个新的 `<g>` 元素中，替换原始元素。

粗糙化系统支持多种SVG基本形状，包括circle（圆形）、ellipse（椭圆）、line（直线）、rect（矩形）、path（路径）、polygon（多边形）和polyline（折线）。对于每种形状，系统会提取其几何属性（如cx、cy、r等）和样式属性，然后调用相应的 roughjs 绘图方法。

矩形的处理特别复杂，因为需要支持圆角。当矩形具有圆角时，系统会将其转换为SVG路径，然后使用 `rc.path` 方法绘制粗糙化效果。多边形和折线的点坐标解析经过特殊处理，能够正确处理各种分隔符（空格和逗号），并提供错误处理机制。

粗糙化配置继承了 roughjs 的所有选项，包括种子值（seed）、笔画宽度、笔画线型等，确保了风格的一致性和可预测性。

**节来源**
- [rough.ts](file://antv_infographic/infographic/src/renderer/stylize/rough.ts#L6-L445)

## 图案与SVG元素结合

图案与SVG元素的结合通过 `applyPatternStyle` 函数实现。该函数首先检查主题配置中的样式化设置，确认是否启用了图案填充。然后根据配置的图案类型从注册表中获取相应的生成器函数。

系统会从SVG元素中提取填充颜色作为基础色，然后根据此颜色计算前景色和背景色。默认情况下，背景色是填充色的半透明版本（透明度50%），前景色保持原填充色。这些颜色与缩放比例等配置一起传递给图案生成器。

图案ID的生成基于图案类型、前景色、背景色和缩放比例，确保了唯一性。生成的图案定义被插入到SVG的defs元素中，如果已存在相同ID的图案则进行更新。最后，SVG元素的填充属性被设置为指向该图案的URL引用（`url(#pattern-id)`）。

一个重要的细节是，当元素没有描边但有填充时，系统会自动将描边设置为与填充相同的颜色，确保视觉一致性。同时，原始元素的ID、CSS类和data属性都会被复制到包裹的 `<g>` 元素上，保持了元素的可识别性和交互性。

**节来源**
- [pattern.ts](file://antv_infographic/infographic/src/renderer/stylize/pattern.ts#L19-L52)

## 性能优化建议

为了确保样式化效果的最佳性能，建议遵循以下优化策略：

1. **合理使用渐变**：渐变定义会被缓存，相同配置的渐变不会重复创建。建议复用渐变配置，避免创建大量相似但ID不同的渐变。

2. **图案缩放优化**：图案的缩放通过 `patternTransform` 实现，比创建不同尺寸的图案定义更高效。建议使用缩放而非创建多个尺寸的图案变体。

3. **粗糙化性能考量**：粗糙化渲染会增加DOM复杂度，因为每个元素都会生成额外的"体积层"和粗糙化版本。对于大量元素的场景，建议谨慎使用或提供关闭选项。

4. **ID生成效率**：系统使用 `getSafetyId` 函数生成安全的ID，基于配置参数的哈希值。复杂的配置可能导致较长的ID，建议保持配置简洁。

5. **批量处理**：当需要对多个元素应用相同样式时，建议批量处理而非逐个调用样式化函数，减少重复计算。

6. **内存管理**：系统会自动更新已存在的样式定义而非创建新的，减少了内存占用。但在动态内容场景中，应定期清理不再使用的defs。

**节来源**
- [gradient.ts](file://antv_infographic/infographic/src/renderer/stylize/gradient.ts#L64-L72)
- [pattern.ts](file://antv_infographic/infographic/src/renderer/stylize/pattern.ts#L54-L62)
- [rough.ts](file://antv_infographic/infographic/src/renderer/stylize/rough.ts#L66-L70)

## 兼容性说明

AntV Infographic 的样式化效果具有良好的浏览器兼容性，基于标准的SVG特性实现。以下是各功能的兼容性详情：

**渐变效果**：支持所有现代浏览器，包括Chrome、Firefox、Safari和Edge。IE11及更早版本对SVG渐变的支持有限，建议在这些环境中降级为纯色填充。

**图案填充**：基于SVG pattern元素，兼容性与渐变类似。所有主流浏览器都支持基本的图案填充功能，包括缩放变换。

**粗糙化渲染**：依赖于 roughjs 库，该库生成标准的SVG元素，因此具有良好的兼容性。但由于会增加DOM复杂度，在低性能设备上可能影响渲染性能。

**通用兼容性建议**：
- 所有样式化功能都通过SVG的defs机制实现，符合SVG 1.1规范
- 颜色处理使用tinycolor2库，支持各种颜色格式（十六进制、RGB、HSL等）
- 在不支持某些特性的环境中，系统会优雅降级，通常表现为纯色填充
- 移动端浏览器完全支持所有功能，但应注意性能影响
- 屏幕阅读器和辅助技术会正常处理这些SVG效果，因为它们不改变元素的语义结构

**节来源**
- [gradient.ts](file://antv_infographic/infographic/src/renderer/stylize/gradient.ts#L2-L3)
- [rough.ts](file://antv_infographic/infographic/src/renderer/stylize/rough.ts#L1-L3)
- [pattern.ts](file://antv_infographic/infographic/src/renderer/stylize/pattern.ts#L1-L3)