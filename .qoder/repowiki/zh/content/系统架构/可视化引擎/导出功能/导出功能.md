# 导出功能

<cite>
**本文档中引用的文件**  
- [src/exporter/index.ts](file://src/exporter/index.ts)
- [src/exporter/svg.ts](file://src/exporter/svg.ts)
- [src/exporter/png.ts](file://src/exporter/png.ts)
- [src/exporter/font.ts](file://src/exporter/font.ts)
- [src/exporter/types.ts](file://src/exporter/types.ts)
- [src/utils/index.ts](file://src/utils/index.ts)
- [esm/exporter/index.d.ts](file://esm/exporter/index.d.ts)
- [esm/exporter/svg.d.ts](file://esm/exporter/svg.d.ts)
- [esm/exporter/png.d.ts](file://esm/exporter/png.d.ts)
- [esm/exporter/font.d.ts](file://esm/exporter/font.d.ts)
</cite>

## 目录
1. [简介](#简介)
2. [导出功能架构](#导出功能架构)
3. [SVG导出机制](#svg导出机制)
4. [PNG导出流程](#png导出流程)
5. [字体嵌入机制](#字体嵌入机制)
6. [导出配置选项](#导出配置选项)
7. [性能考虑与大文件处理](#性能考虑与大文件处理)
8. [错误处理与质量优化](#错误处理与质量优化)
9. [使用示例](#使用示例)

## 简介
AntV Infographic 提供了强大的多格式导出能力，支持将信息图表导出为 SVG 和 PNG 格式。本文档详细说明了导出功能的实现机制、配置选项和最佳实践，帮助开发者充分利用该功能。

## 导出功能架构

```mermaid
graph TD
A[导出入口] --> B[exportToSVGString]
A --> C[exportToPNGString]
B --> D[SVG导出]
C --> E[PNG导出]
D --> F[字体嵌入]
D --> G[图标嵌入]
D --> H[资源嵌入]
E --> I[Canvas渲染]
E --> J[分辨率控制]
F --> K[FontFace API]
G --> L[use元素处理]
H --> M[远程资源内联]
I --> N[图像平滑]
J --> O[DPR设置]
```

**Diagram sources**
- [src/exporter/index.ts](file://src/exporter/index.ts)
- [src/exporter/svg.ts](file://src/exporter/svg.ts)
- [src/exporter/png.ts](file://src/exporter/png.ts)

**Section sources**
- [src/exporter/index.ts](file://src/exporter/index.ts)
- [esm/exporter/index.d.ts](file://esm/exporter/index.d.ts)

## SVG导出机制

SVG导出模块将渲染树序列化为标准SVG文档，确保导出的SVG文件具有完整的结构和样式信息。

```mermaid
sequenceDiagram
participant 用户 as 用户
participant 导出模块 as 导出模块
participant SVG处理 as SVG处理
participant 字体嵌入 as 字体嵌入
用户->>导出模块 : 调用exportToSVGString()
导出模块->>SVG处理 : 克隆SVG节点
SVG处理->>SVG处理 : 设置视图框属性
SVG处理->>SVG处理 : 嵌入图标
SVG处理->>字体嵌入 : 嵌入字体资源
字体嵌入-->>SVG处理 : 返回处理后的字体
SVG处理->>SVG处理 : 清理SVG结构
SVG处理-->>导出模块 : 返回处理后的SVG
导出模块->>导出模块 : 序列化为字符串
导出模块-->>用户 : 返回data URL
```

**Diagram sources**
- [src/exporter/svg.ts](file://src/exporter/svg.ts)
- [esm/exporter/svg.d.ts](file://esm/exporter/svg.d.ts)

**Section sources**
- [src/exporter/svg.ts](file://src/exporter/svg.ts)
- [esm/exporter/svg.d.ts](file://esm/exporter/svg.d.ts)

## PNG导出流程

PNG导出功能基于Canvas的渲染转换过程，将SVG内容渲染为高质量的PNG图像。

```mermaid
flowchart TD
Start([开始导出]) --> CloneSVG["克隆SVG元素"]
CloneSVG --> GetViewBox["获取视图框尺寸"]
GetViewBox --> CreateCanvas["创建Canvas元素"]
CreateCanvas --> SetCanvasSize["设置Canvas尺寸"]
SetCanvasSize --> ApplyDPR["应用DPR缩放"]
ApplyDPR --> EnableSmoothing["启用图像平滑"]
EnableSmoothing --> SerializeSVG["序列化SVG为字符串"]
SerializeSVG --> CreateDataURL["创建data URL"]
CreateDataURL --> LoadImage["加载SVG图像"]
LoadImage --> OnLoad["图像加载完成"]
OnLoad --> ClearCanvas["清除Canvas"]
ClearCanvas --> DrawImage["绘制图像到Canvas"]
DrawImage --> ToDataURL["转换为PNG data URL"]
ToDataURL --> ReturnResult["返回结果"]
LoadImage --> OnError["图像加载失败"]
OnError --> RejectError["拒绝Promise"]
ReturnResult --> End([结束])
RejectError --> End
```

**Diagram sources**
- [src/exporter/png.ts](file://src/exporter/png.ts)
- [esm/exporter/png.d.ts](file://esm/exporter/png.d.ts)

**Section sources**
- [src/exporter/png.ts](file://src/exporter/png.ts)
- [esm/exporter/png.d.ts](file://esm/exporter/png.d.ts)

## 字体嵌入机制

字体嵌入机制确保导出图像的字体一致性，通过FontFace API获取和嵌入实际加载的字体。

```mermaid
classDiagram
class FontEmbedder {
+embedFonts(svg : SVGSVGElement, embedResources? : boolean) Promise~void~
+parseFontFamily(fontFamily : string) Promise~Partial~FontFaceAttributes~[]~
+getActualLoadedFontFace(fontFamily : string) FontFace[]
}
class FontFaceAttributes {
+family : string
+style : string
+weight : string
+stretch : string
+unicodeRange : string
+variant : string
+featureSettings : string
}
class SVGProcessor {
+exportToSVG(svg : SVGSVGElement, options? : SVGExportOptions) Promise~SVGSVGElement~
+exportToSVGString(svg : SVGSVGElement, options? : SVGExportOptions) Promise~string~
}
FontEmbedder --> SVGProcessor : "被调用"
SVGProcessor --> FontEmbedder : "调用"
```

**Diagram sources**
- [src/exporter/font.ts](file://src/exporter/font.ts)
- [esm/exporter/font.d.ts](file://esm/exporter/font.d.ts)

**Section sources**
- [src/exporter/font.ts](file://src/exporter/font.ts)
- [esm/exporter/font.d.ts](file://esm/exporter/font.d.ts)

## 导出配置选项

### SVG导出配置
| 配置项 | 类型 | 默认值 | 描述 |
|-------|------|--------|------|
| type | 'svg' | - | 导出类型 |
| embedResources | boolean | true | 是否将远程资源嵌入到SVG中 |

### PNG导出配置
| 配置项 | 类型 | 默认值 | 描述 |
|-------|------|--------|------|
| type | 'png' | - | 导出类型 |
| dpr | number | devicePixelRatio或2 | 设备像素比，影响导出分辨率 |

**Section sources**
- [src/exporter/types.ts](file://src/exporter/types.ts)
- [esm/exporter/types.d.ts](file://esm/exporter/types.d.ts)

## 性能考虑与大文件处理

```mermaid
graph TD
A[性能优化] --> B[内存管理]
A --> C[渲染效率]
A --> D[资源加载]
B --> E[避免内存泄漏]
B --> F[及时释放资源]
C --> G[优化DPR设置]
C --> H[减少重绘]
D --> I[字体预加载]
D --> J[资源缓存]
K[大文件处理] --> L[分块处理]
K --> M[流式导出]
K --> N[进度反馈]
L --> O[分阶段渲染]
M --> P[渐进式输出]
N --> Q[提供进度事件]
```

**Section sources**
- [src/exporter/png.ts](file://src/exporter/png.ts)
- [src/exporter/svg.ts](file://src/exporter/svg.ts)

## 错误处理与质量优化

### 错误处理策略
- **Canvas上下文获取失败**：检查浏览器是否支持Canvas API
- **图像加载失败**：验证SVG数据的有效性
- **字体嵌入失败**：确保字体已正确加载
- **内存不足**：对于大尺寸图表，建议降低DPR值

### 质量优化建议
1. **图像平滑**：启用`imageSmoothingEnabled`和`imageSmoothingQuality`
2. **DPR设置**：根据目标用途选择合适的设备像素比
3. **字体一致性**：确保所有使用的字体都已正确嵌入
4. **资源内联**：将远程资源嵌入到导出文件中，确保可移植性

**Section sources**
- [src/exporter/png.ts](file://src/exporter/png.ts)
- [src/exporter/font.ts](file://src/exporter/font.ts)

## 使用示例

### SVG导出示例
```typescript
import { exportToSVGString } from '@antv/infographic';

// 导出SVG
const svgDataUrl = await exportToSVGString(svgElement, {
  embedResources: true
});
```

### PNG导出示例
```typescript
import { exportToPNGString } from '@antv/infographic';

// 导出PNG，使用高分辨率
const pngDataUrl = await exportToPNGString(svgElement, {
  dpr: 3 // 高DPR值，适合打印
});
```

**Section sources**
- [src/exporter/index.ts](file://src/exporter/index.ts)
- [src/exporter/svg.ts](file://src/exporter/svg.ts)
- [src/exporter/png.ts](file://src/exporter/png.ts)