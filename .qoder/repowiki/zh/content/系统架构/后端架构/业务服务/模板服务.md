# 模板服务

<cite>
**本文档引用的文件**   
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py)
- [template.py](file://backend/app/models/template.py)
- [template_repo.py](file://backend/app/repositories/template_repo.py)
- [dify_workflows.yaml](file://backend/app/config/dify_workflows.yaml)
- [llm_prompts.yaml](file://backend/app/config/llm_prompts.yaml)
- [templates.py](file://backend/app/api/v1/templates.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概述](#架构概述)
4. [详细组件分析](#详细组件分析)
5. [依赖分析](#依赖分析)
6. [性能考虑](#性能考虑)
7. [故障排除指南](#故障排除指南)
8. [结论](#结论)

## 项目结构

```mermaid
graph TD
subgraph "Backend"
subgraph "Services"
template_service[模板服务]
type_classification_service[类型识别服务]
workflow_mapper[工作流映射器]
template_selection_service[模板选择服务]
end
subgraph "Models"
template_model[模板模型]
end
subgraph "Repositories"
template_repo[模板仓库]
end
subgraph "Config"
dify_config[dify_workflows.yaml]
prompts_config[llm_prompts.yaml]
end
subgraph "API"
templates_api[templates.py]
end
end
subgraph "Frontend"
templates_api_client[templates.ts]
end
template_service --> template_repo
template_service --> template_model
type_classification_service --> prompts_config
workflow_mapper --> dify_config
template_selection_service --> template_service
templates_api --> template_service
templates_api --> template_selection_service
templates_api_client --> templates_api
```

**图示来源**
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py)
- [template.py](file://backend/app/models/template.py)
- [template_repo.py](file://backend/app/repositories/template_repo.py)
- [dify_workflows.yaml](file://backend/app/config/dify_workflows.yaml)
- [llm_prompts.yaml](file://backend/app/config/llm_prompts.yaml)
- [templates.py](file://backend/app/api/v1/templates.py)

**本节来源**
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py)

## 核心组件

模板服务系统由多个核心组件构成，包括模板服务、类型识别服务、工作流映射器和模板选择服务。这些组件协同工作，为用户提供智能的模板推荐和管理功能。

**本节来源**
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py)

## 架构概述

```mermaid
graph TD
User[用户] --> Frontend[前端]
Frontend --> Backend[后端API]
subgraph "Backend"
API[templates.py]
TemplateService[TemplateService]
TypeClassificationService[TypeClassificationService]
TemplateSelectionService[TemplateSelectionService]
WorkflowMapper[WorkflowMapper]
TemplateRepo[TemplateRepository]
Database[(数据库)]
end
API --> TemplateService
API --> TemplateSelectionService
TemplateSelectionService --> TypeClassificationService
TemplateSelectionService --> TemplateService
TemplateService --> TemplateRepo
TemplateRepo --> Database
TemplateService --> WorkflowMapper
```

**图示来源**
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py)
- [templates.py](file://backend/app/api/v1/templates.py)

## 详细组件分析

### 模板服务分析

模板服务是系统的核心组件，负责管理所有模板的生命周期，包括模板的分类管理、检索查询和元数据处理。

```mermaid
classDiagram
class TemplateService {
+get_all_templates(category, keyword, page, page_size) Dict
+get_template_by_id(template_id) Optional[Dict]
+get_templates_by_category(category) List[Dict]
+get_categories() List[Dict]
+search_templates(keyword) List[Dict]
}
class TemplateRepository {
+get_all(category, keyword, is_active, page, page_size) tuple[List[Template], int]
+get_by_id(template_id) Optional[Template]
+get_by_category(category) List[Template]
+get_categories() List[Dict]
}
class Template {
+id : String
+name : String
+category : String
+structure_type : String
+description : Text
+keywords : Text
+use_cases : Text
+preview_url : String
+data_schema : JSON
+design_config : JSON
+tags : JSON
+sort_order : Integer
+is_active : Boolean
+created_at : DateTime
+updated_at : DateTime
+to_dict() Dict
}
TemplateService --> TemplateRepository : "使用"
TemplateRepository --> Template : "操作"
```

**图示来源**
- [template_service.py](file://backend/app/services/template_service.py#L160-L281)
- [template_repo.py](file://backend/app/repositories/template_repo.py#L13-L144)
- [template.py](file://backend/app/models/template.py#L9-L54)

**本节来源**
- [template_service.py](file://backend/app/services/template_service.py#L1-L281)
- [template_repo.py](file://backend/app/repositories/template_repo.py#L1-L144)
- [template.py](file://backend/app/models/template.py#L1-L54)

### 类型识别服务分析

类型识别服务负责分析用户需求并匹配最佳模板类型，通过LLM技术实现智能分类。

```mermaid
sequenceDiagram
participant User as "用户"
participant API as "API"
participant TemplateSelectionService as "TemplateSelectionService"
participant TypeClassificationService as "TypeClassificationService"
participant LLMClient as "LLMClient"
User->>API : POST /templates/recommend
API->>TemplateSelectionService : recommend_templates()
TemplateSelectionService->>TypeClassificationService : classify(user_text)
TypeClassificationService->>LLMClient : chat_completion()
LLMClient-->>TypeClassificationService : JSON响应
TypeClassificationService->>TypeClassificationService : _parse_response()
TypeClassificationService->>TypeClassificationService : _validate_result()
TypeClassificationService-->>TemplateSelectionService : 分类结果
TemplateSelectionService->>TemplateSelectionService : 选择模板
TemplateSelectionService-->>API : 推荐结果
API-->>User : 返回推荐模板
```

**图示来源**
- [type_classification_service.py](file://backend/app/services/type_classification_service.py#L14-L149)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py#L15-L169)
- [templates.py](file://backend/app/api/v1/templates.py#L77-L99)

**本节来源**
- [type_classification_service.py](file://backend/app/services/type_classification_service.py#L1-L149)

### 工作流映射器分析

工作流映射器负责将模板与Dify工作流关联，实现模板与后端工作流的映射管理。

```mermaid
flowchart TD
Start([初始化]) --> LoadConfig["加载dify_workflows.yaml配置"]
LoadConfig --> CheckExist{"配置文件存在?"}
CheckExist --> |否| ReturnEmpty["返回空映射"]
CheckExist --> |是| ReadConfig["读取YAML配置"]
ReadConfig --> ParseConfig["解析配置为字典"]
ParseConfig --> StoreMappings["存储映射关系到mappings"]
StoreMappings --> End([初始化完成])
GetWorkflowConfig["get_workflow_config(template_id)"] --> CheckMapping{"模板ID在映射中?"}
CheckMapping --> |否| ReturnNone["返回None"]
CheckMapping --> |是| CheckEnabled{"工作流启用?"}
CheckEnabled --> |否| ReturnNone
CheckEnabled --> |是| ReturnConfig["返回工作流配置"]
```

**图示来源**
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py#L13-L157)
- [dify_workflows.yaml](file://backend/app/config/dify_workflows.yaml#L1-L81)

**本节来源**
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py#L1-L157)
- [dify_workflows.yaml](file://backend/app/config/dify_workflows.yaml#L1-L81)

### 模板选择服务分析

模板选择服务根据用户需求和内容类型，从候选模板中选择最合适的模板。

```mermaid
flowchart TD
Start([选择模板入口]) --> GetTemplates["获取候选模板"]
GetTemplates --> CheckTemplates{"找到模板?"}
CheckTemplates --> |否| UseAllTemplates["使用所有模板"]
CheckTemplates --> |是| GetPrompt["获取提示词"]
UseAllTemplates --> GetPrompt
GetPrompt --> ConstructMessages["构造消息"]
ConstructMessages --> CallLLM["调用LLM"]
CallLLM --> ParseResponse["解析响应"]
ParseResponse --> ValidateResult["验证结果"]
ValidateResult --> CheckTemplateId{"模板ID在候选列表中?"}
CheckTemplateId --> |否| UseDefault["使用默认模板"]
CheckTemplateId --> |是| ReturnResult["返回选择结果"]
UseDefault --> ReturnResult
```

**图示来源**
- [template_selection_service.py](file://backend/app/services/template_selection_service.py#L15-L169)
- [llm_prompts.yaml](file://backend/app/config/llm_prompts.yaml#L93-L137)

**本节来源**
- [template_selection_service.py](file://backend/app/services/template_selection_service.py#L1-L169)

### 模板分类体系

```mermaid
erDiagram
TEMPLATE ||--o{ CATEGORY : "属于"
CATEGORY {
string code PK
string name
string description
int count
}
TEMPLATE {
string id PK
string name
string category FK
string structure_type
text description
text keywords
text use_cases
string preview_url
json data_schema
json design_config
json tags
int sort_order
boolean is_active
datetime created_at
datetime updated_at
}
CATEGORY ||--o{ TEMPLATE : "包含"
```

**图示来源**
- [template.py](file://backend/app/models/template.py#L9-L54)
- [template_repo.py](file://backend/app/repositories/template_repo.py#L113-L121)

## 依赖分析

```mermaid
graph TD
template_service[template_service.py] --> template_repo[template_repo.py]
template_service --> template_model[template.py]
template_service --> workflow_mapper[workflow_mapper.py]
type_classification_service[type_classification_service.py] --> llm_prompts[llm_prompts.yaml]
template_selection_service[template_selection_service.py] --> template_service
template_selection_service --> type_classification_service
templates_api[templates.py] --> template_service
templates_api --> template_selection_service
frontend[templates.ts] --> templates_api
workflow_mapper[workflow_mapper.py] --> dify_workflows[dify_workflows.yaml]
```

**图示来源**
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py)
- [template.py](file://backend/app/models/template.py)
- [template_repo.py](file://backend/app/repositories/template_repo.py)
- [dify_workflows.yaml](file://backend/app/config/dify_workflows.yaml)
- [llm_prompts.yaml](file://backend/app/config/llm_prompts.yaml)
- [templates.py](file://backend/app/api/v1/templates.py)

**本节来源**
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)
- [template_selection_service.py](file://backend/app/services/template_selection_service.py)

## 性能考虑

模板服务通过数据库索引、分页查询和缓存机制确保快速响应模板查询请求。系统使用复合索引(idx_category_sort)来优化分类和排序查询，同时通过分页机制限制单次查询的数据量，避免性能瓶颈。

**本节来源**
- [template.py](file://backend/app/models/template.py#L30-L33)
- [template_repo.py](file://backend/app/repositories/template_repo.py#L68-L71)

## 故障排除指南

当模板服务出现问题时，可以检查以下方面：
1. 确认数据库连接正常
2. 检查模板数据是否正确加载
3. 验证LLM服务是否可用
4. 确认配置文件路径正确

**本节来源**
- [template_service.py](file://backend/app/services/template_service.py)
- [type_classification_service.py](file://backend/app/services/type_classification_service.py)
- [workflow_mapper.py](file://backend/app/services/workflow_mapper.py)

## 结论

模板服务系统通过模块化设计实现了模板的分类管理、智能推荐和工作流集成。系统具有良好的可维护性和扩展性，便于未来添加新的模板类别或调整分类规则。