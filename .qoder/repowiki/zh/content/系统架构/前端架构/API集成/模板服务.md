# æ¨¡æ¿æœåŠ¡APIè¯¦ç»†æ–‡æ¡£

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [templates.py](file://backend/app/api/v1/templates.py)
- [template_service.py](file://backend/app/services/template_service.py)
- [template_repo.py](file://backend/app/repositories/template_repo.py)
- [template.py](file://backend/app/models/template.py)
- [template.ts](file://frontend/src/api/templates.ts)
- [template.ts](file://frontend/src/stores/template.ts)
- [client.ts](file://frontend/src/api/client.ts)
- [common.py](file://backend/app/schemas/common.py)
- [template.py](file://backend/app/schemas/template.py)
- [Examples.vue](file://frontend/src/views/Examples/Examples.vue)
- [db.py](file://backend/app/utils/db.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [APIç«¯ç‚¹è¯¦è§£](#apiç«¯ç‚¹è¯¦è§£)
4. [æ•°æ®æ¨¡å‹ä¸ç»“æ„](#æ•°æ®æ¨¡å‹ä¸ç»“æ„)
5. [å‰ç«¯é›†æˆæŒ‡å—](#å‰ç«¯é›†æˆæŒ‡å—)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [é”™è¯¯å¤„ç†ä¸é™çº§æ–¹æ¡ˆ](#é”™è¯¯å¤„ç†ä¸é™çº§æ–¹æ¡ˆ)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
9. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ç®€ä»‹

AntV Infographicæ¨¡æ¿æœåŠ¡æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¿¡æ¯å›¾è¡¨æ¨¡æ¿ç®¡ç†ç³»ç»Ÿï¼Œä¸ºç”¨æˆ·æä¾›ä¸°å¯Œçš„å¯è§†åŒ–æ¨¡æ¿é€‰æ‹©å’Œæ™ºèƒ½æ¨èåŠŸèƒ½ã€‚è¯¥æœåŠ¡é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œåç«¯åŸºäºFastAPIæ„å»ºRESTful APIï¼Œå‰ç«¯ä½¿ç”¨Vue.jsæ¡†æ¶å®ç°æ¨¡æ¿é€‰æ‹©ç•Œé¢ã€‚

### æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

- **æ¨¡æ¿åˆ—è¡¨ç®¡ç†**ï¼šæ”¯æŒåˆ†é¡µã€åˆ†ç±»ç­›é€‰ã€å…³é”®è¯æœç´¢çš„æ¨¡æ¿æµè§ˆ
- **æ™ºèƒ½æ¨è**ï¼šåŸºäºAIçš„æ¨¡æ¿æ¨èç®—æ³•ï¼Œæ ¹æ®ç”¨æˆ·è¾“å…¥å†…å®¹åŒ¹é…æœ€é€‚åˆçš„æ¨¡æ¿
- **åˆ†ç±»ä½“ç³»**ï¼šä¸ƒå¤§åˆ†ç±»ä½“ç³»è¦†ç›–ä¸åŒç±»å‹çš„å¯è§†åŒ–éœ€æ±‚
- **é¢„è§ˆåŠŸèƒ½**ï¼šå®æ—¶æ¨¡æ¿é¢„è§ˆå’Œé…ç½®å±•ç¤º
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæœ¬åœ°ç¼“å­˜ã€æ‡’åŠ è½½ç­‰ä¼˜åŒ–ç­–ç•¥

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
subgraph "å‰ç«¯å±‚"
FE[Vue.js å‰ç«¯åº”ç”¨]
Store[Pinia çŠ¶æ€ç®¡ç†]
API[API å®¢æˆ·ç«¯]
end
subgraph "åç«¯å±‚"
FastAPI[FastAPI åº”ç”¨]
Router[è·¯ç”±å¤„ç†å™¨]
Service[æ¨¡æ¿æœåŠ¡]
Repo[æ•°æ®ä»“åº“]
DB[(æ•°æ®åº“)]
end
subgraph "AIæœåŠ¡å±‚"
LLM[LLM å®¢æˆ·ç«¯]
Workflow[Dify å·¥ä½œæµ]
end
FE --> API
API --> FastAPI
FastAPI --> Router
Router --> Service
Service --> Repo
Repo --> DB
Service --> LLM
LLM --> Workflow
```

**æ¶æ„å›¾æ¥æº**
- [templates.py](file://backend/app/api/v1/templates.py#L1-L99)
- [template_service.py](file://backend/app/services/template_service.py#L160-L281)
- [template.ts](file://frontend/src/api/templates.ts#L1-L52)

## APIç«¯ç‚¹è¯¦è§£

### 1. è·å–æ¨¡æ¿åˆ—è¡¨

**ç«¯ç‚¹**: `GET /api/v1/templates`

**åŠŸèƒ½**: è·å–å¯ç”¨çš„ä¿¡æ¯å›¾æ¨¡æ¿åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µã€åˆ†ç±»ç­›é€‰å’Œå…³é”®è¯æœç´¢ã€‚

**è¯·æ±‚å‚æ•°**:

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | æè¿° |
|--------|------|------|--------|------|
| category | string | å¦ | - | æŒ‰åˆ†ç±»ç­›é€‰ï¼ˆå¯é€‰ï¼‰ |
| keyword | string | å¦ | - | æœç´¢å…³é”®è¯ï¼ˆå¯é€‰ï¼‰ |
| page | number | å¦ | 1 | é¡µç ï¼ˆé»˜è®¤1ï¼‰ |
| pageSize | number | å¦ | 20 | æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼Œæœ€å¤§100ï¼‰ |

**å“åº”ç»“æ„**:

```typescript
interface TemplateListResponse {
  success: boolean;
  data: {
    templates: Template[];
    total: number;
    page: number;
    pageSize: number;
  };
  message: string;
}
```

**ä»£ç ç¤ºä¾‹**:
```typescript
// åŸºæœ¬è¯·æ±‚
const templates = await getTemplates();

// å¸¦ç­›é€‰æ¡ä»¶çš„è¯·æ±‚
const filteredTemplates = await getTemplates({
  category: 'chart',
  keyword: 'é”€å”®',
  page: 1,
  pageSize: 20
});
```

**èŠ‚æ¥æº**
- [templates.py](file://backend/app/api/v1/templates.py#L17-L40)
- [template.ts](file://frontend/src/api/templates.ts#L26-L28)

### 2. è·å–æ¨¡æ¿è¯¦æƒ…

**ç«¯ç‚¹**: `GET /api/v1/templates/{template_id}`

**åŠŸèƒ½**: è·å–æŒ‡å®šæ¨¡æ¿çš„è¯¦ç»†ä¿¡æ¯ã€‚

**è·¯å¾„å‚æ•°**:

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| template_id | string | æ˜¯ | æ¨¡æ¿å”¯ä¸€æ ‡è¯†ç¬¦ |

**å“åº”ç»“æ„**:

```typescript
interface TemplateDetailResponse {
  success: boolean;
  data: Template;
  message: string;
}
```

**é”™è¯¯å¤„ç†**:
- 404: æ¨¡æ¿ä¸å­˜åœ¨

**èŠ‚æ¥æº**
- [templates.py](file://backend/app/api/v1/templates.py#L61-L74)

### 3. è·å–åˆ†ç±»åˆ—è¡¨

**ç«¯ç‚¹**: `GET /api/v1/templates/categories`

**åŠŸèƒ½**: è·å–æ‰€æœ‰æ¨¡æ¿åˆ†ç±»åŠæ¯ä¸ªåˆ†ç±»çš„æ¨¡æ¿æ•°é‡ç»Ÿè®¡ã€‚

**å“åº”ç»“æ„**:

```typescript
interface CategoriesResponse {
  success: boolean;
  data: Category[];
  message: string;
}

interface Category {
  code: string;
  name: string;
  description: string;
  count: number;
}
```

**é¢„å®šä¹‰åˆ†ç±»**:
- `chart`: å›¾è¡¨å‹ - æ•°å€¼å±•ç¤º
- `comparison`: å¯¹æ¯”å‹ - ä¼˜åŠ£å¯¹æ¯”  
- `hierarchy`: å±‚çº§å‹ - ç»„ç»‡æ¶æ„
- `list`: åˆ—è¡¨å‹ - æ­¥éª¤è¯´æ˜
- `quadrant`: å››è±¡é™å‹ - å¸‚åœºå®šä½
- `relation`: å…³ç³»å‹ - å…³ç³»ç½‘ç»œ
- `sequence`: é¡ºåºå‹ - æ—¶é—´çº¿æµç¨‹

**èŠ‚æ¥æº**
- [templates.py](file://backend/app/api/v1/templates.py#L42-L58)

### 4. AIæ¨¡æ¿æ¨è

**ç«¯ç‚¹**: `POST /api/v1/templates/recommend`

**åŠŸèƒ½**: æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹ï¼Œä½¿ç”¨AIæ¨èæœ€åˆé€‚çš„ä¿¡æ¯å›¾æ¨¡æ¿ã€‚

**è¯·æ±‚ä½“**:

```typescript
interface TemplateRecommendRequest {
  text: string;           // ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬å†…å®¹ï¼ˆå¿…å¡«ï¼‰
  maxRecommendations?: number; // æœ€å¤šæ¨èæ•°é‡ï¼ˆ1-10ï¼Œé»˜è®¤5ï¼‰
}
```

**å“åº”ç»“æ„**:

```typescript
interface TemplateRecommendResponse {
  success: boolean;
  data: {
    recommendations: TemplateRecommendation[];
    analysisTime: number;
  };
  message: string;
}

interface TemplateRecommendation {
  templateId: string;
  templateName: string;
  confidence: number;    // ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
  matchScore: number;    // ç™¾åˆ†æ¯”å½¢å¼çš„åŒ¹é…åº¦
  reason: string;        // æ¨èç†ç”±
  category?: string;     // å¯é€‰åˆ†ç±»
}
```

**èŠ‚æ¥æº**
- [templates.py](file://backend/app/api/v1/templates.py#L77-L99)
- [template.py](file://backend/app/schemas/template.py#L8-L27)

## æ•°æ®æ¨¡å‹ä¸ç»“æ„

### åç«¯æ•°æ®æ¨¡å‹

```mermaid
classDiagram
class Template {
+string id
+string name
+string category
+string structure_type
+string description
+string keywords
+string use_cases
+string preview_url
+JSON data_schema
+JSON design_config
+JSON tags
+number sort_order
+boolean is_active
+DateTime created_at
+DateTime updated_at
+to_dict() dict
}
class TemplateService {
+get_all_templates()
+get_template_by_id()
+get_categories()
+search_templates()
}
class TemplateRepository {
+get_all()
+get_by_id()
+get_by_category()
+get_categories()
}
TemplateService --> TemplateRepository
TemplateRepository --> Template
```

**ç±»å›¾æ¥æº**
- [template.py](file://backend/app/models/template.py#L9-L54)
- [template_service.py](file://backend/app/services/template_service.py#L160-L281)

### å‰ç«¯æ•°æ®æ¥å£

```typescript
interface Template {
  id: string;
  name: string;
  category: string;
  description?: string;
  useCases?: string;
  previewUrl?: string;
  tags?: string[];
  dataSchema: any;
  designConfig: any;
}

interface Category {
  code: string;
  name: string;
  description: string;
  count: number;
}
```

**èŠ‚æ¥æº**
- [template.ts](file://frontend/src/stores/template.ts#L8-L34)
- [template.py](file://backend/app/models/template.py#L35-L53)

### æ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|--------|------|------|------|
| id | string | æ¨¡æ¿å”¯ä¸€æ ‡è¯†ç¬¦ | "list-row-simple-horizontal-arrow" |
| name | string | æ¨¡æ¿æ˜¾ç¤ºåç§° | "ç®€å•æ¨ªå‘æµç¨‹å›¾" |
| category | string | åˆ†ç±»ä»£ç  | "list", "chart", "comparison" |
| structureType | string | AntVç»“æ„ç±»å‹ | "list-row", "sequence-timeline" |
| description | string | æ¨¡æ¿æè¿° | "å¸¦ç®­å¤´çš„æ¨ªå‘åˆ—è¡¨å¸ƒå±€..." |
| useCases | string | é€‚ç”¨åœºæ™¯ | "æ­¥éª¤è¯´æ˜ã€æµç¨‹å±•ç¤ºã€æ“ä½œæŒ‡å—" |
| previewUrl | string | é¢„è§ˆå›¾URL | "/assets/previews/template.png" |
| dataSchema | JSON | æ•°æ®ç»“æ„Schema | åŒ…å«å­—æ®µå®šä¹‰å’ŒéªŒè¯è§„åˆ™ |
| designConfig | JSON | è®¾è®¡é…ç½® | AntVè®¾è®¡ç³»ç»Ÿçš„é…ç½®å‚æ•° |
| tags | JSONæ•°ç»„ | æ ‡ç­¾æ•°ç»„ | ["æµç¨‹", "æ­¥éª¤", "å›¾æ ‡"] |
| sortOrder | number | æ’åºæƒé‡ | 100 |

## å‰ç«¯é›†æˆæŒ‡å—

### çŠ¶æ€ç®¡ç†é›†æˆ

ä½¿ç”¨Piniaè¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œé›†ä¸­ç®¡ç†æ¨¡æ¿æ•°æ®ï¼š

```typescript
// åœ¨æ¨¡æ¿é€‰æ‹©é¡µé¢ä¸­ä½¿ç”¨
const templateStore = useTemplateStore();

// åŠ è½½æ¨¡æ¿æ•°æ®
await templateStore.fetchTemplates(category, keyword);

// è·å–åˆ†ç±»æ•°æ®
await templateStore.fetchCategories();

// è·å–AIæ¨è
const recommendations = await templateStore.fetchRecommendations(text);
```

**èŠ‚æ¥æº**
- [template.ts](file://frontend/src/stores/template.ts#L36-L102)

### æ¨¡æ¿é€‰æ‹©é¡µé¢å®ç°

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant UI as æ¨¡æ¿ç•Œé¢
participant Store as Pinia Store
participant API as APIå®¢æˆ·ç«¯
participant Backend as åç«¯æœåŠ¡
User->>UI : æ‰“å¼€æ¨¡æ¿é€‰æ‹©
UI->>Store : fetchTemplates()
Store->>API : getTemplates()
API->>Backend : GET /templates
Backend-->>API : æ¨¡æ¿åˆ—è¡¨æ•°æ®
API-->>Store : å“åº”æ•°æ®
Store-->>UI : æ›´æ–°çŠ¶æ€
UI-->>User : æ˜¾ç¤ºæ¨¡æ¿ç½‘æ ¼
User->>UI : ç‚¹å‡»æ¨¡æ¿
UI->>UI : æ˜¾ç¤ºæ¨¡æ¿è¯¦æƒ…
User->>UI : é€‰æ‹©æ¨¡æ¿
UI->>Store : è®¾ç½®é€‰ä¸­æ¨¡æ¿
```

**åºåˆ—å›¾æ¥æº**
- [Examples.vue](file://frontend/src/views/Examples/Examples.vue#L240-L267)
- [template.ts](file://frontend/src/stores/template.ts#L44-L54)

### æ¨¡æ¿ç½‘æ ¼æ¸²æŸ“

æ¨¡æ¿ç½‘æ ¼é‡‡ç”¨å“åº”å¼å¸ƒå±€ï¼Œæ”¯æŒåˆ†ç±»ç­›é€‰å’Œæœç´¢ï¼š

```typescript
// è¿‡æ»¤é€»è¾‘
const filteredTemplates = computed(() => {
  if (!selectedCategory.value) {
    return templates.value;
  }
  return templates.value.filter(t => t.category === selectedCategory.value);
});

// åˆ†ç±»æ˜ å°„
const categoryMap = {
  'sequence': { name: 'é¡ºåºå‹', icon: 'ğŸ”„' },
  'list': { name: 'åˆ—è¡¨å‹', icon: 'ğŸ“‹' },
  'comparison': { name: 'å¯¹æ¯”å‹', icon: 'âš–ï¸' },
  'relation': { name: 'å…³ç³»å‹', icon: 'ğŸ”—' },
  'hierarchy': { name: 'å±‚çº§å‹', icon: 'ğŸ”ï¸' },
  'chart': { name: 'å›¾è¡¨å‹', icon: 'ğŸ“Š' },
  'quadrant': { name: 'å››è±¡é™å‹', icon: 'ğŸ¯' }
};
```

**èŠ‚æ¥æº**
- [Examples.vue](file://frontend/src/views/Examples/Examples.vue#L39-L279)

### APIå®¢æˆ·ç«¯é…ç½®

```typescript
// APIå®¢æˆ·ç«¯åŸºç¡€é…ç½®
const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 120000, // æ”¯æŒé•¿æ—¶é—´çš„AIå¤„ç†
  headers: {
    'Content-Type': 'application/json'
  }
});

// é”™è¯¯å¤„ç†
apiClient.interceptors.response.use(
  (response) => response.data,
  (error) => {
    console.error('APIè¯·æ±‚å¤±è´¥:', error);
    return Promise.reject(error);
  }
);
```

**èŠ‚æ¥æº**
- [client.ts](file://frontend/src/api/client.ts#L16-L46)

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. åˆ†é¡µæœºåˆ¶

åç«¯å®ç°é«˜æ•ˆçš„åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®ï¼š

```python
# æŸ¥è¯¢ä¼˜åŒ–
templates = query.order_by(
    Template.sort_order.desc(),
    Template.created_at.desc()
).offset((page - 1) * page_size).limit(page_size).all()
```

**åˆ†é¡µå‚æ•°ä¼˜åŒ–**:
- é»˜è®¤æ¯é¡µ20ä¸ªæ¨¡æ¿
- æœ€å¤§æ”¯æŒ100ä¸ªæ¨¡æ¿/é¡µ
- ä½¿ç”¨å¤åˆç´¢å¼•åŠ é€ŸæŸ¥è¯¢

**èŠ‚æ¥æº**
- [template_repo.py](file://backend/app/repositories/template_repo.py#L67-L71)

### 2. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```python
# å¤åˆç´¢å¼•
__table_args__ = (
    Index('idx_category_sort', 'category', 'sort_order'),
)
```

**ç´¢å¼•ç­–ç•¥**:
- `category` + `sort_order` å¤åˆç´¢å¼•
- æ”¯æŒå¿«é€Ÿåˆ†ç±»ç­›é€‰å’Œæ’åº
- å‡å°‘å…¨è¡¨æ‰«æ

**èŠ‚æ¥æº**
- [template.py](file://backend/app/models/template.py#L30-L33)

### 3. å‰ç«¯ç¼“å­˜ç­–ç•¥

```typescript
// æ¨¡æ¿æ•°æ®ç¼“å­˜
const templates = ref<Template[]>([]);

// åˆ†ç±»æ•°æ®ç¼“å­˜
const categories = ref<Category[]>([]);

// æ¨èç»“æœç¼“å­˜
const recommendations = ref<TemplateRecommendation[]>([]);
```

**ç¼“å­˜ç­–ç•¥**:
- åˆ†ç±»æ•°æ®ä¸€æ¬¡æ€§åŠ è½½å¹¶ç¼“å­˜
- æ¨¡æ¿åˆ—è¡¨æ”¯æŒå¢é‡åŠ è½½
- AIæ¨èç»“æœä¸´æ—¶ç¼“å­˜

**èŠ‚æ¥æº**
- [template.ts](file://frontend/src/stores/template.ts#L38-L41)

### 4. æ‡’åŠ è½½å®ç°

```typescript
// æ¨¡æ¿é¢„è§ˆæ‡’åŠ è½½
const renderPreviews = () => {
  filteredTemplates.value.forEach((template, index) => {
    const container = previewRefs.value[index];
    if (container) {
      // å¼‚æ­¥æ¸²æŸ“é¢„è§ˆ
      setTimeout(() => {
        renderTemplatePreview(container, template);
      }, 100);
    }
  });
};
```

**æ‡’åŠ è½½ç‰¹ç‚¹**:
- æŒ‰éœ€æ¸²æŸ“æ¨¡æ¿é¢„è§ˆ
- é¿å…åˆå§‹åŠ è½½é˜»å¡
- æå‡é¦–å±æ¸²æŸ“é€Ÿåº¦

**èŠ‚æ¥æº**
- [Examples.vue](file://frontend/src/views/Examples/Examples.vue#L270-L317)

### 5. æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

```python
# ç”Ÿäº§ç¯å¢ƒé…ç½®
engine = create_engine(
    DATABASE_URL,
    pool_pre_ping=True,
    pool_size=10,
    max_overflow=20
)
```

**è¿æ¥æ± é…ç½®**:
- æœ€å°è¿æ¥æ•°: 10
- æœ€å¤§æº¢å‡º: 20
- è‡ªåŠ¨å¥åº·æ£€æŸ¥
- è¿æ¥è¶…æ—¶è‡ªåŠ¨é‡è¯•

**èŠ‚æ¥æº**
- [db.py](file://backend/app/utils/db.py#L29-L36)

## é”™è¯¯å¤„ç†ä¸é™çº§æ–¹æ¡ˆ

### 1. APIé”™è¯¯å¤„ç†

```typescript
// å‰ç«¯é”™è¯¯å¤„ç†
try {
  const response = await getTemplates({ page: 1, pageSize: 100 });
  if (response.success && response.data) {
    templates.value = response.data.templates;
  }
} catch (error) {
  console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
  // æ˜¾ç¤ºé”™è¯¯æç¤º
  showErrorMessage('æ— æ³•è·å–æ¨¡æ¿åˆ—è¡¨ï¼Œè¯·ç¨åé‡è¯•');
}
```

**é”™è¯¯ç±»å‹å¤„ç†**:
- ç½‘ç»œé”™è¯¯: æ˜¾ç¤ºé‡è¯•æŒ‰é’®
- æœåŠ¡å™¨é”™è¯¯: æ˜¾ç¤ºç»´æŠ¤æç¤º
- æ•°æ®æ ¼å¼é”™è¯¯: ä½¿ç”¨é»˜è®¤æ•°æ®

**èŠ‚æ¥æº**
- [template.ts](file://frontend/src/stores/template.ts#L44-L54)

### 2. åç«¯é”™è¯¯å¤„ç†

```python
# 404é”™è¯¯å¤„ç†
if not template:
    raise HTTPException(status_code=404, detail=f"æ¨¡æ¿ä¸å­˜åœ¨: {template_id}")

# 500é”™è¯¯å¤„ç†
except Exception as e:
    raise HTTPException(status_code=500, detail=str(e))
```

**ç»Ÿä¸€å“åº”æ ¼å¼**:
```python
class APIResponse(BaseModel):
    success: bool
    data: Optional[T] = None
    message: str = "æ“ä½œæˆåŠŸ"
```

**èŠ‚æ¥æº**
- [templates.py](file://backend/app/api/v1/templates.py#L71-L73)
- [common.py](file://backend/app/schemas/common.py#L10-L15)

### 3. æœåŠ¡ä¸å¯ç”¨é™çº§

```python
# æ•°æ®åº“è¿æ¥å¤±è´¥é™çº§
def get_template_service():
    global _template_service
    if _template_service is None:
        try:
            _template_service = TemplateService()
        except Exception as e:
            logger.warning(f"æ¨¡æ¿æœåŠ¡åˆå§‹åŒ–å¤±è´¥: {e}")
            # ä½¿ç”¨å†…å­˜ç¼“å­˜çš„é™æ€æ•°æ®
            _template_service = create_fallback_service()
    return _template_service
```

**é™çº§ç­–ç•¥**:
- æ•°æ®åº“è¿æ¥å¤±è´¥æ—¶ä½¿ç”¨å†…å­˜ç¼“å­˜
- é™æ€æ¨¡æ¿æ•°æ®ä½œä¸ºåå¤‡
- AIæœåŠ¡ä¸å¯ç”¨æ—¶ç¦ç”¨æ¨èåŠŸèƒ½

### 4. å‰ç«¯é™çº§å¤„ç†

```typescript
// æ¨¡æ¿åŠ è½½å¤±è´¥å¤„ç†
const loadData = async () => {
  try {
    // å°è¯•ä»APIè·å–æ•°æ®
    const templatesRes = await getTemplates({ page: 1, pageSize: 100 });
    if (templatesRes.success && templatesRes.data) {
      templates.value = templatesRes.data.templates;
    }
  } catch (error) {
    // é™çº§åˆ°æœ¬åœ°ç¼“å­˜æˆ–é»˜è®¤æ¨¡æ¿
    console.warn('APIä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜');
    templates.value = getDefaultTemplates();
  }
};
```

**èŠ‚æ¥æº**
- [template.ts](file://frontend/src/stores/template.ts#L240-L267)

## æœ€ä½³å®è·µ

### 1. è¯·æ±‚å‚æ•°éªŒè¯

```typescript
// åç«¯å‚æ•°éªŒè¯
@router.get("")
async def get_templates(
    category: Optional[str] = Query(None, description="æŒ‰åˆ†ç±»ç­›é€‰"),
    keyword: Optional[str] = Query(None, description="æœç´¢å…³é”®è¯"),
    page: int = Query(1, description="é¡µç ", ge=1),
    pageSize: int = Query(20, description="æ¯é¡µæ•°é‡", ge=1, le=100)
):
```

**éªŒè¯è§„åˆ™**:
- é¡µç å¿…é¡» â‰¥ 1
- æ¯é¡µæ•°é‡èŒƒå›´: 1-100
- åˆ†ç±»å‚æ•°å¯é€‰
- å…³é”®è¯å‚æ•°å¯é€‰

**èŠ‚æ¥æº**
- [templates.py](file://backend/app/api/v1/templates.py#L18-L23)

### 2. æ•°æ®ç¼“å­˜ç­–ç•¥

```python
# ç¼“å­˜ç­–ç•¥ç¤ºä¾‹
@lru_cache(maxsize=100)
def get_template_by_id_cached(template_id: str):
    """ç¼“å­˜æ¨¡æ¿è¯¦æƒ…æŸ¥è¯¢"""
    return template_service.get_template_by_id(template_id)
```

**ç¼“å­˜å±‚æ¬¡**:
- Redisç¼“å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- å†…å­˜ç¼“å­˜ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- æµè§ˆå™¨ç¼“å­˜

### 3. å¹¶å‘æ§åˆ¶

```python
# AIæ¨èå¹¶å‘é™åˆ¶
from functools import lru_cache
import asyncio

class RateLimitedService:
    def __init__(self):
        self.semaphore = asyncio.Semaphore(5)  # é™åˆ¶å¹¶å‘æ•°
    
    async def recommend_with_limit(self, text: str):
        async with self.semaphore:
            return await self.recommend_templates(text)
```

### 4. æ—¥å¿—è®°å½•

```python
# è¯¦ç»†çš„æ—¥å¿—è®°å½•
logger.info(f"[TemplateAPI] è·å–æ¨¡æ¿åˆ—è¡¨: category={category}, keyword={keyword}, "
           f"page={page}, pageSize={pageSize}")
```

**æ—¥å¿—çº§åˆ«**:
- INFO: æ­£å¸¸æ“ä½œè®°å½•
- WARNING: æ€§èƒ½è­¦å‘Š
- ERROR: é”™è¯¯è®°å½•
- DEBUG: è¯¦ç»†è°ƒè¯•ä¿¡æ¯

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æ¨¡æ¿åŠ è½½ç¼“æ…¢

**ç—‡çŠ¶**: æ¨¡æ¿åˆ—è¡¨åŠ è½½æ—¶é—´è¶…è¿‡3ç§’

**åŸå› åˆ†æ**:
- æ•°æ®åº“æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•
- ç½‘ç»œå»¶è¿Ÿè¿‡é«˜
- å‰ç«¯æ¸²æŸ“é˜»å¡

**è§£å†³æ–¹æ¡ˆ**:
```python
# æ·»åŠ æŸ¥è¯¢ä¼˜åŒ–
query = query.options(
    Load(Template).undefer("preview_url"),  # é¢„åŠ è½½å›¾ç‰‡URL
    Load(Template).undefer("description")   # é¢„åŠ è½½æè¿°
)
```

#### 2. AIæ¨èä¸å‡†ç¡®

**ç—‡çŠ¶**: AIæ¨èçš„æ¨¡æ¿ä¸ç”¨æˆ·éœ€æ±‚ä¸ç¬¦

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ–‡æœ¬é•¿åº¦
2. éªŒè¯LLMé…ç½®
3. æŸ¥çœ‹æ¨èç½®ä¿¡åº¦

**è§£å†³æ–¹æ¡ˆ**:
```python
# å¢å¼ºæ¨èè´¨é‡
if confidence < 0.3:
    return fallback_recommendation(user_text)
```

#### 3. åˆ†ç±»ç»Ÿè®¡é”™è¯¯

**ç—‡çŠ¶**: æŸäº›åˆ†ç±»çš„æ¨¡æ¿æ•°é‡æ˜¾ç¤ºä¸º0

**æ’æŸ¥æ–¹æ³•**:
```python
# æ£€æŸ¥æ¨¡æ¿æ¿€æ´»çŠ¶æ€
templates = db.query(Template).filter(
    Template.category == category,
    Template.is_active == True
).count()
```

#### 4. å‰ç«¯ç¼“å­˜é—®é¢˜

**ç—‡çŠ¶**: æ›´æ”¹æ¨¡æ¿åå‰ç«¯æ˜¾ç¤ºæ—§æ•°æ®

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
const refreshTemplates = async () => {
  templates.value = [];
  await templateStore.fetchTemplates();
};
```

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›‘æ§æ–¹æ³• |
|------|--------|----------|
| æ¨¡æ¿åˆ—è¡¨å“åº”æ—¶é—´ | < 500ms | å‰ç«¯æ€§èƒ½ç›‘æ§ |
| AIæ¨èå“åº”æ—¶é—´ | < 3s | åç«¯æ—¥å¿—åˆ†æ |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 100ms | SQLæ…¢æŸ¥è¯¢æ—¥å¿— |
| å‰ç«¯æ¸²æŸ“æ—¶é—´ | < 200ms | æµè§ˆå™¨æ€§èƒ½å·¥å…· |

### è°ƒè¯•å·¥å…·

```typescript
// è°ƒè¯•æ¨¡å¼é…ç½®
const DEBUG_MODE = process.env.NODE_ENV === 'development';

if (DEBUG_MODE) {
  // å¯ç”¨è¯¦ç»†æ—¥å¿—
  console.log('æ¨¡æ¿APIè¯·æ±‚:', { params });
  console.log('å“åº”æ•°æ®:', response);
}
```

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µå’Œæ•…éšœæ’é™¤æŒ‡å—ï¼Œå¯ä»¥ç¡®ä¿æ¨¡æ¿æœåŠ¡çš„ç¨³å®šæ€§å’Œé«˜æ€§èƒ½è¿è¡Œã€‚å®šæœŸç›‘æ§å’Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼ŒåŠæ—¶å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œä¸ºç”¨æˆ·æä¾›ä¼˜è´¨çš„æ¨¡æ¿é€‰æ‹©ä½“éªŒã€‚