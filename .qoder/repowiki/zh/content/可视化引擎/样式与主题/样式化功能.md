# 样式化功能

<cite>
**本文档中引用的文件**  
- [gradient.ts](file://antv_infographic\infographic\src\renderer\stylize\gradient.ts)
- [rough.ts](file://antv_infographic\infographic\src\renderer\stylize\rough.ts)
- [diamond.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\diamond.ts)
- [dot.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\dot.ts)
- [hex.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\hex.ts)
- [line.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\line.ts)
- [mosaic.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\mosaic.ts)
- [square.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\square.ts)
- [LinearGradient.js](file://antv_infographic\infographic\esm\designs\defs\LinearGradient.js)
</cite>

## 目录
1. [渐变样式](#渐变样式)
2. [图案填充系统](#图案填充系统)
3. [粗糙草图风格](#粗糙草图风格)
4. [JSX中的样式应用](#jsx中的样式应用)
5. [样式优先级与组合限制](#样式优先级与组合限制)
6. [导出格式兼容性](#导出格式兼容性)
7. [性能调优建议](#性能调优建议)

## 渐变样式

AntV Infographic的渐变功能通过`applyGradientStyle`函数实现，支持线性渐变和径向渐变两种类型。该函数根据配置生成相应的SVG渐变元素，并将其应用到目标节点上。

线性渐变的实现基于角度到单位向量的转换算法，通过`angleToUnitVector`函数将指定角度转换为SVG线性渐变所需的起点和终点坐标。该算法使用标准的三角函数计算，在屏幕坐标系中0度对应x轴正方向，90度对应y轴正方向。颜色插值通过创建多个`stop`元素实现，这些元素均匀分布在渐变路径上，形成平滑的颜色过渡效果。

当未明确指定颜色配置时，系统会自动推断渐变配置。对于深色背景，算法会生成从当前颜色到其变亮20%版本的渐变；对于浅色背景，则生成从其变暗20%版本到当前颜色的渐变。这种智能推断机制确保了良好的视觉对比度和可读性。

径向渐变的实现相对简单，仅需创建`radialGradient`元素并添加相应的颜色停止点。所有渐变配置都通过`getGradientId`函数生成唯一的标识符，该标识符基于渐变类型、颜色组合和角度（对于线性渐变）生成，确保了渐变资源的高效复用。

**中文(中文)**
- [gradient.ts](file://antv_infographic\infographic\src\renderer\stylize\gradient.ts#L6-L132)

## 图案填充系统

图案填充系统提供了六种内置图案：点状（dot）、六边形（hex）、线条（line）、菱形（diamond）、马赛克（mosaic）和方块（square）。每种图案都通过独立的生成器函数实现，这些函数遵循统一的`PatternGenerator`接口。

点状图案由两个交错排列的圆点组成，形成对角线重复模式。六边形图案使用正六边形路径填充，创造出蜂窝状视觉效果。线条图案包含两条交叉的半透明线条，形成网格效果。菱形图案通过两条交叉的对角线构成X形图案。马赛克图案采用棋盘格布局，由交替的前景色和背景色方块组成。方块图案则在背景上叠加前景色的完整方块。

所有图案生成器都支持缩放控制，通过`patternTransform`属性实现。图案的默认尺寸为20×20用户空间单位，确保在不同缩放级别下保持清晰度。性能优化方面，系统通过`getOrCreateDefs`函数确保图案定义只创建一次，并在多个元素间共享，避免了重复定义造成的资源浪费。

**中文(中文)**
- [diamond.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\diamond.ts#L1-L30)
- [dot.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\dot.ts#L1-L38)
- [hex.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\hex.ts#L1-L30)
- [line.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\line.ts#L1-L47)
- [mosaic.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\mosaic.ts#L1-L46)
- [square.ts](file://antv_infographic\infographic\src\renderer\stylize\patterns\square.ts#L1-L30)

## 粗糙草图风格

粗糙草图风格的实现基于Rough.js库，通过`applyRoughStyle`函数将标准SVG元素转换为手绘风格的图形。该函数首先创建一个Rough.js渲染器实例，然后根据原始元素的类型调用相应的绘制方法。

路径抖动算法是手绘效果的核心，它通过在原始路径上添加随机偏移来模拟手绘的不规则性。对于不支持直接粗糙化的元素类型（如带圆角的矩形），系统会先将其转换为SVG路径，然后再应用粗糙化处理。这种转换确保了所有形状类型都能获得一致的手绘效果。

Canvas渲染适配方面，系统通过`createElement`和`setAttributes`等工具函数确保生成的粗糙化元素能够正确集成到现有的SVG结构中。每个粗糙化元素都被包装在一个`<g>`元素内，保留了原始元素的变换、类名和数据属性，同时添加了特殊的CSS类（如`rough-element`）以便于样式控制。

**中文(中文)**
- [rough.ts](file://antv_infographic\infographic\src\renderer\stylize\rough.ts#L6-L445)

## JSX中的样式应用

在JSX中，可以通过`style`属性或`defs`定义来应用高级样式。对于渐变样式，可以使用`LinearGradient`组件在`defs`中定义渐变，然后通过`url(#id)`引用。例如，`LinearGradient`组件支持`id`、`startColor`、`stopColor`和`direction`等属性，允许开发者指定渐变的起始颜色、结束颜色和方向（左到右、右到左、上到下、下到上）。

图案填充可以直接在元素的`fill`属性中引用预定义的图案ID，或通过样式配置动态生成。粗糙草图风格可以通过在元素上设置特定的粗糙化配置对象来启用，该对象可以包含种子值、笔触宽度等参数，以控制手绘效果的外观。

**中文(中文)**
- [LinearGradient.js](file://antv_infographic\infographic\esm\designs\defs\LinearGradient.js#L1-L11)

## 样式优先级与组合限制

样式优先级遵循CSS标准的层叠规则，后定义的样式会覆盖先定义的样式。当同时应用多种高级样式时，系统会按照特定顺序处理：首先应用渐变，然后是图案填充，最后是粗糙化效果。这种顺序确保了视觉效果的可预测性和一致性。

组合使用方面存在一些限制。例如，同时应用渐变和图案填充可能会导致不可预期的视觉效果，因为两者都作用于填充属性。同样，将粗糙化效果应用于已经具有复杂图案填充的元素可能会降低性能并影响渲染质量。建议在实际使用中根据具体需求选择最合适的样式组合。

## 导出格式兼容性

在SVG导出格式中，所有高级样式都能完整保留，因为它们本身就是基于SVG标准实现的。渐变、图案和粗糙化效果都会被正确编码为SVG元素，确保在各种SVG查看器中的一致性。

PNG导出格式的兼容性取决于渲染过程。由于PNG是位图格式，所有矢量效果都会被光栅化。这意味着渐变和图案填充会转换为像素数据，而粗糙化效果会作为手绘纹理保留在图像中。需要注意的是，高分辨率导出可能会显著增加文件大小，特别是在包含大量复杂样式的图表中。

## 性能调优建议

性能优化的关键在于合理使用样式资源。图案缓存机制通过`getOrCreateDefs`函数实现，确保相同的图案定义不会被重复创建。渐变复用通过基于配置生成唯一ID的机制实现，相同配置的渐变会被自动共享。

对于复杂样式，建议实施降级处理策略。例如，在低性能设备上可以禁用粗糙化效果，或使用简单的纯色填充替代复杂的图案填充。此外，避免在大量元素上同时应用多种高级样式，可以通过分批渲染或简化非关键元素的样式来提高整体性能。